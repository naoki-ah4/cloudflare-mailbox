# Cloudflare Mailbox 開発ガイドライン

このドキュメントには、このリポジトリの開発に関するガイドラインが含まれています。開発者は日本人であるため、PR や Issue の内容は日本語で記載してください。

そのため、リポジトリに含まれる英語のドキュメントは全て日本語から翻訳されたものです。例えば CLAUDE.md は、CLAUDE_ja.md を英語に翻訳したものです。そのため、CLAUDE.md のみを編集することは避けてください。CLAUDE_ja.md を編集したコミットの後に CLAUDE.md を更新するコミットを作成してください。

## コーディングルール

このリポジトリでは、以下のコーディングルールを採用しています。

### TypeScript (主に型に関するルール)

- アサーションは一切使用しないこと、使用する場合はコメントに理由を記載すること
  - ただし、`as const`や`satisfies`は使用してもよい
- `any`や`unknown`は使用しないこと
- `inteface`は`type`で代用できる場合は使用しないこと
- 複雑な型は`type`で定義すること、export するのも可

### 命名規則

#### キャメルケース (ローワーキャメルケース)

- 変数名
- 関数名
- クラス名のインスタンス変数
- クラス名のメソッド名

#### パスカルケース (アッパーキャメルケース)

- クラス名
- タイプエイリアス

### JavaScript (主に構文に関するルール)

- let はなるべく使用しないこと、const を使用すること
- forEach はなるべく使用しないこと、map や filter を使用すること
  - for of は使用してもよい
- function キーワードはなるべく使用しないこと、原則 const とアロー関数で定義すること
- Promise の then はなるべく使用しないこと、async/await を使用すること
- オブジェクトのプロパティの順序は、以下の順にすること
  - プロパティ名
  - コンストラクタ
  - メソッド
  - getter/setter

# Cloudflare Mailbox システム仕様書

## 概要

Cloudflare Workers と KV を使用したメールボックス管理システム。複数のメールアドレスを一元管理し、効率的なメール処理を提供します。

## 主要機能

### 1. ユーザー管理システム

#### 認証方式

- **ユーザー名ベース認証**: メールアドレスではなくユーザー名でログイン
- **招待制**: 管理者が発行した招待トークンによる登録のみ
- **セッション管理**: JWT 形式でのセッション管理

#### ユーザー情報

```typescript
User {
  id: string (UUID)
  username: string (3-30文字、英数字とアンダースコア)
  email: string (連絡用メールアドレス)
  managedEmails: string[] (管理対象メールアドレス一覧)
  passwordHash: string
  createdAt: number
  lastLogin?: number
}
```

**重要な制約**:

- `email`（連絡用）と`managedEmails`（管理用）は重複不可
- `email`: システム通知・パスワードリセット等の連絡先
- `managedEmails`: 実際にメール受信・管理するアドレス

### 2. 複数メールボックス管理

#### 基本概念

- 1 ユーザーが複数のメールアドレスを管理可能
- 各メールアドレスは独立した inbox を持つ
- 統合ビューでの一括表示も可能

#### API 機能

- **統合表示**: 全管理メールボックスの統合表示
- **個別表示**: 特定メールボックスのみ表示
- **アクセス制御**: 管理対象メールアドレスのみアクセス可能

### 3. パフォーマンス最適化

#### KV 設計

- **O(1)アクセス**: ユーザー名インデックス (`username:key → userId`)
- **list 操作回避**: 高コストな list 操作を最小限に抑制
- **並列処理**: 複数メールボックスの並列取得

#### データ構造

```
KV構造:
- user:{userId} → User情報
- username:{username} → userId (インデックス)
- session:{sessionId} → Session情報
- inbox:{email} → EmailMetadata[]
- msg:{messageId} → EmailMessage
- thread:{threadId} → messageId[]
```

### KV 最適化戦略

1. **インデックス活用**: 頻繁アクセスは専用インデックス作成
2. **list 操作回避**: 管理画面等の低頻度のみ list 使用
3. **並列処理**: Promise.all による効率的なデータ取得
4. **クライアント処理**: ソート・フィルタリングはクライアント側

### パフォーマンス考慮事項

- ログイン時の O(1)ユーザー検索
- 複数メールボックスの並列取得
- クライアント側でのメール統合・ソート
- 高コストな list 操作の最小化

## 今後の拡張予定

### 機能拡張

- カスタムフォルダ機能
- メール送信機能
- 添付ファイル対応の強化
- 高度な検索・フィルタリング

### 運用面

- メトリクス・ログ収集
- 障害監視
- バックアップ・復旧
- スケーリング対応

---

最終更新: 2025 年 6 月 28 日
