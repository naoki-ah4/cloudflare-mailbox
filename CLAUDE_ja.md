# Cloudflare Mailbox 開発ガイドライン

このドキュメントには、このリポジトリの開発に関するガイドラインが含まれています。開発者は日本人であるため、PR や Issue の内容は日本語で記載してください。

そのため、リポジトリに含まれる英語のドキュメントは全て日本語から翻訳されたものです。例えば CLAUDE.md は、CLAUDE_ja.md を英語に翻訳したものです。そのため、CLAUDE.md のみを編集することは避けてください。CLAUDE_ja.md を編集したコミットの後に CLAUDE.md を更新するコミットを作成してください。

## コーディングルール

このリポジトリでは、以下のコーディングルールを採用しています。

### TypeScript (主に型に関するルール)

- アサーションは一切使用しないこと、使用する場合はコメントに理由を記載すること
  - ただし、`as const`や`satisfies`は使用してもよい
- `any`や`unknown`は使用しないこと
- `inteface`は`type`で代用できる場合は使用しないこと
- 複雑な型は`type`で定義すること、export するのも可

### 命名規則

#### キャメルケース (ローワーキャメルケース)

- 変数名
- 関数名
- クラス名のインスタンス変数
- クラス名のメソッド名

#### パスカルケース (アッパーキャメルケース)

- クラス名
- タイプエイリアス

### JavaScript (主に構文に関するルール)

- let はなるべく使用しないこと、const を使用すること
- forEach はなるべく使用しないこと、map や filter を使用すること
  - for of は使用してもよい
- function キーワードはなるべく使用しないこと、原則 const とアロー関数で定義すること
- Promise の then はなるべく使用しないこと、async/await を使用すること
- オブジェクトのプロパティの順序は、以下の順にすること
  - プロパティ名
  - コンストラクタ
  - メソッド
  - getter/setter

## 開発環境ガイドライン

### パッケージ管理

- **bun を使用すること**: `npm` の代わりに `bun` を使用してください
  - インストール: `bun install`
  - 実行: `bun run dev`, `bun run build`, etc.

### Git 管理

- **ignore されたファイルはコミットしないこと**: `.gitignore` で除外されているファイル（`wrangler.jsonc` など）は `-f` フラグを使用してもコミットしないでください
- **関連ファイルのみコミット**: 機能実装時は関連するファイルのみを段階的にコミットしてください

### React Router v7 ルーティング

- **ファイルベースルーティングの制限**: ファイルを作成するだけでは自動的にルートが生成されません
- **明示的なルート定義が必要**: 新しいページを作成した場合は `src/app/routes.ts` にルート定義を追加してください
  - 例: `route("/admin/new-page", "routes/admin/new-page.tsx")`
- **ネストしたルート**: サブページも個別に定義が必要
  - 例: `route("/admin/settings/history", "routes/admin/settings/history.tsx")`

### AI アシスタント向けガイドライン

- **開発用サーバーを起動しないこと**: Claude や Gemini などの AI は `npm run dev` や `bun run dev` などのサーバー起動コマンドを実行してはいけません
  - 理由: プロセスが停止せず、セッションが応答不能になるため
  - 代替案: 静的チェック（`bun run typecheck`, `bun run lint`）を使用してください
- **新しいページ作成時**: ファイル作成後は必ず `src/app/routes.ts` にルート定義を追加してください

# Cloudflare Mailbox システム仕様書

## 概要

Cloudflare Workers と KV を使用したメールボックス管理システム。複数のメールアドレスを一元管理し、効率的なメール処理を提供します。

## 主要機能

### 1. ユーザー管理システム

#### 認証方式

- **ユーザー名ベース認証**: メールアドレスではなくユーザー名でログイン
- **招待制**: 管理者が発行した招待トークンによる登録のみ
- **ハイブリッドセッション管理**: React Router v7 + KV統合方式
  - Cookie: sessionIdのみ（React Router管理）
  - KV: セッションデータ永続化（期限管理・強制ログアウト対応）

#### ユーザー情報

```typescript
User {
  id: string (UUID)
  username: string (3-30文字、英数字とアンダースコア)
  email: string (連絡用メールアドレス)
  managedEmails: string[] (管理対象メールアドレス一覧)
  passwordHash: string
  createdAt: number
  lastLogin?: number
}
```

**重要な制約**:

- `email`（連絡用）と`managedEmails`（管理用）は重複不可
- `email`: システム通知・パスワードリセット等の連絡先
- `managedEmails`: 実際にメール受信・管理するアドレス

### 2. 複数メールボックス管理

#### 基本概念

- 1 ユーザーが複数のメールアドレスを管理可能
- 各メールアドレスは独立した inbox を持つ
- 統合ビューでの一括表示も可能

#### API 機能

- **統合表示**: 全管理メールボックスの統合表示
- **個別表示**: 特定メールボックスのみ表示
- **アクセス制御**: 管理対象メールアドレスのみアクセス可能

### 3. パフォーマンス最適化

#### KV 設計

- **O(1)アクセス**: ユーザー名インデックス (`username:key → userId`)
- **list 操作回避**: 高コストな list 操作を最小限に抑制
- **並列処理**: 複数メールボックスの並列取得

#### データ構造

```
KV構造:
- user:{userId} → User情報
- username:{username} → userId (インデックス)
- session:{sessionId} → ユーザーSession情報
- admin:{adminId} → Admin情報
- admin-username:{username} → adminId (インデックス)
- admin-session:{sessionId} → 管理者Session情報
- inbox:{email} → EmailMetadata[]
- msg:{messageId} → EmailMessage
- thread:{threadId} → messageId[]

React Router v7 Cookie:
- __user_session: {sessionId: string}
- __admin_session: {sessionId: string}
```

### KV 最適化戦略

1. **インデックス活用**: 頻繁アクセスは専用インデックス作成
2. **list 操作回避**: 管理画面等の低頻度のみ list 使用
3. **並列処理**: Promise.all による効率的なデータ取得
4. **クライアント処理**: ソート・フィルタリングはクライアント側

### パフォーマンス考慮事項

- ログイン時の O(1)ユーザー検索
- 複数メールボックスの並列取得
- クライアント側でのメール統合・ソート
- 高コストな list 操作の最小化

## 現在の実装状況

### ✅ 完了済み機能

#### 認証・セッション管理
- **React Router v7 + KV統合**: Cookie（sessionId）+ KV（セッションデータ）のハイブリッド構成
- **管理者認証**: IP制限 + セッション認証、初期セットアップ対応
- **ユーザー認証**: 招待制登録、ユーザー名ベースログイン
- **統一セッション管理**: `session.server.ts`で管理者・ユーザー両方を統一管理

#### メール機能
- **メール一覧**: 複数メールボックス統合表示、個別表示切り替え
- **メール詳細**: HTML/テキスト表示、添付ファイル対応
- **既読管理**: 個別メール既読化、未読カウント表示
- **検索・フィルタ**: 送信者、件名、日付範囲での絞り込み

#### 管理者機能
- **ダッシュボード**: 統計情報表示（ユーザー数、管理者数）
- **ユーザー管理**: 一覧表示、削除機能
- **招待管理**: 招待URL生成、管理画面
- **管理者管理**: 管理者追加、一覧、削除

#### UI実装
- **レスポンシブ設計**: 全ページモバイル完全対応
  - 統一ブレイクポイント: 768px（モバイル）, 1024px（タブレット）
  - モバイルドロワーナビゲーション + デスクトップサイドバー
  - CSS Modules によるスコープ化スタイル管理
- **ランディングページ**: 未認証ユーザー向けホーム
- **ユーザーダッシュボード**: 認証後のメイン画面

#### ユーザー設定機能
- **基本設定ページ**: `/settings` - テーマ、言語、タイムゾーン、通知設定
- **プロフィール管理**: `/profile` - ユーザー情報表示・編集、管理メール設定
- **パスワード変更**: `/settings/password` - セキュアなパスワード更新
- **統一設定ナビゲーション**: レスポンシブ対応のナビゲーション

#### メール機能拡張
- **ページネーション**: 50件単位の効率的なページング（完了済み）
- **フォルダ管理**: カスタムフォルダ作成・メール移動
- **署名付きURL**: 添付ファイルの外部アクセス対応

### 🚧 実装中・未完了機能

#### UI/UX改善
- **ダークモード対応**: テーマ切り替え機能（設定項目のみ実装済み）
- **通知・トースト**: ユーザーフィードバック強化
- **ローディング状態**: 操作中の適切な状態表示

### 🏗️ アーキテクチャ特徴

#### React Router v7対応
- **File-based routing**: 直感的なルート構成
- **Loader/Action pattern**: データ取得・更新の分離
- **Type-safe**: TypeScript完全対応

#### Cloudflare Workers最適化
- **Edge computing**: 世界中の低レイテンシ配信
- **KV Storage**: 効率的なデータ永続化
- **R2 Storage**: 添付ファイルの安全な保存

#### セキュリティ対策
- **IP制限**: 管理者アクセスの地理的制限
- **セッション管理**: 適切な期限切れ・無効化
- **アクセス制御**: 管理対象メールアドレスベースの権限制御

## 今後の拡張予定

### 短期計画（1-2ヶ月）
- ダークモード実装（設定項目は完了済み）
- UI/UX改善（通知機能、ローディング状態）
- 添付ファイル署名付きURL対応

### 中期計画（3-6ヶ月）
- カスタムフォルダ機能
- メール送信機能
- 高度な検索・フィルタリング

### 長期計画（6ヶ月以上）
- メトリクス・ログ収集
- 障害監視・アラート
- バックアップ・復旧システム
- スケーリング対応

---

## フロントエンド設計仕様

### レスポンシブデザイン

#### ブレイクポイント戦略
```scss
// 統一ブレイクポイント
@media (max-width: 768px)  // モバイル
@media (max-width: 1024px) // タブレット
// 1024px以上: デスクトップ
```

#### レイアウトパターン
- **モバイル（～768px）**: ドロワーナビゲーション + フルスクリーンコンテンツ
- **タブレット（769px～1024px）**: 適応的レイアウト
- **デスクトップ（1025px～）**: サイドバー + メインコンテンツ

#### ナビゲーション設計
- **SettingsNav**: CSS Modules + React状態管理
  - モバイル: ハンバーガーメニュー + オーバーレイドロワー
  - デスクトップ: 固定サイドバー
  - 自動閉じ機能（リンククリック時・オーバーレイタップ時）

### CSS アーキテクチャ

#### スタイリング戦略
- **CSS Modules**: コンポーネント固有スタイル（`.module.scss`）
- **Tailwind CSS**: ユーティリティクラス（レイアウト・色・間隔）
- **SCSS**: 複雑なレスポンシブロジック・ネスト構造

#### ファイル構成
```
src/app/
├── components/
│   ├── SettingsNav.tsx
│   └── SettingsNav.module.scss
├── routes/
│   ├── messages.tsx
│   └── messages.module.scss
```

---

最終更新: 2025 年 6 月 30 日（レスポンシブデザイン仕様追加）
