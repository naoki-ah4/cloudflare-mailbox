# Cloudflare Mailbox 開発ガイドライン

このドキュメントには、このリポジトリの開発に関するガイドラインが含まれています。開発者は日本人であるため、PR や Issue の内容は日本語で記載してください。

そのため、リポジトリに含まれる英語のドキュメントは全て日本語から翻訳されたものです。例えば CLAUDE.md は、CLAUDE_ja.md を英語に翻訳したものです。そのため、CLAUDE.md のみを編集することは避けてください。CLAUDE_ja.md を編集したコミットの後に CLAUDE.md を更新するコミットを作成してください。

## コーディングルール

このリポジトリでは、以下のコーディングルールを採用しています。

### TypeScript (主に型に関するルール)

- アサーションは一切使用しないこと、使用する場合はコメントに理由を記載すること
  - ただし、`as const`や`satisfies`は使用してもよい
- `any`や`unknown`は使用しないこと
- `inteface`は`type`で代用できる場合は使用しないこと
- 複雑な型は`type`で定義すること、export するのも可

### 命名規則

#### キャメルケース (ローワーキャメルケース)

- 変数名
- 関数名
- クラス名のインスタンス変数
- クラス名のメソッド名

#### パスカルケース (アッパーキャメルケース)

- クラス名
- タイプエイリアス

### JavaScript (主に構文に関するルール)

- let はなるべく使用しないこと、const を使用すること
- forEach はなるべく使用しないこと、map や filter を使用すること
  - for of は使用してもよい
- function キーワードはなるべく使用しないこと、原則 const とアロー関数で定義すること
- Promise の then はなるべく使用しないこと、async/await を使用すること
- オブジェクトのプロパティの順序は、以下の順にすること
  - プロパティ名
  - コンストラクタ
  - メソッド
  - getter/setter

## 開発環境ガイドライン

### パッケージ管理

- **bun を使用すること**: `npm` の代わりに `bun` を使用してください
  - インストール: `bun install`
  - 実行: `bun run dev`, `bun run build`, etc.

### Git 管理

- **ignore されたファイルはコミットしないこと**: `.gitignore` で除外されているファイル（`wrangler.jsonc` など）は `-f` フラグを使用してコミットしないでください
- **関連ファイルのみコミット**: 機能実装時は関連するファイルのみを段階的にコミットしてください

### React Router v7 ルーティング

- **明示的なルート定義が必要**: 新しいページを作成した場合は `src/app/routes.ts` にルート定義を追加してください
  - 例: `route("/admin/new-page", "routes/admin/new-page.tsx")`
- **ネストしたルート**: サブページも個別に定義が必要
  - 例: `route("/admin/settings/history", "routes/admin/settings/history.tsx")`

### AI アシスタント向けガイドライン

- **開発用サーバーを起動しないこと**: Claude や Gemini などの AI は `npm run dev` や `bun run dev` などのサーバー起動コマンドを実行してはいけません
  - 理由: プロセスが停止せず、セッションが応答不能になるため

# Cloudflare Mailbox システム仕様書

## 概要

Cloudflare Workers と KV を使用したメールボックス管理システム。複数のメールアドレスを一元管理し、効率的なメール処理を提供します。

## 主要機能

### 1. ユーザー管理システム

- **ユーザー名ベース認証**: メールアドレスではなくユーザー名でログイン
- **招待制**: 管理者が発行した招待トークンによる登録のみ
- **ハイブリッドセッション管理**: React Router v7 + KV 統合方式
  - Cookie: sessionId のみ（React Router 管理）
  - KV: セッションデータ永続化（期限管理・強制ログアウト対応）

### 2. 複数メールボックス管理

- 1 ユーザーが複数のメールアドレスを管理可能
- 各メールアドレスは独立した inbox を持つ
- 統合ビューでの一括表示も可能

### 3. パフォーマンス最適化

#### KV 設計

- **O(1)アクセス**: ユーザー名インデックス (`username:key → userId`)
- **list 操作回避**: 高コストな list 操作を最小限に抑制
- **並列処理**: 複数メールボックスの並列取得

#### データ構造

- src/utils/kv には、KV ストレージ用のデータ構造が定義されています。
  - src/utils/kv/schema.ts: KV に格納するデータの validation スキーマ
  - そのほかは、KV ストレージの操作に関するユーティリティ関数が定義されています。

**KV ストレージにアクセスする際は必ずユーティリティ関数を使用してください。直接アクセスは避けてください**

### 🏗️ アーキテクチャ特徴

- **React Router v7**: 最新のルーティング機能を活用
- **Cloudflare Workers**: 高速なエッジコンピューティング

---

## フロントエンド設計仕様

### レスポンシブデザイン

#### レイアウトパターン

- **モバイル（～ 768px）**: ドロワーナビゲーション + フルスクリーンコンテンツ
- **タブレット（769px ～ 1024px）**: 適応的レイアウト
- **デスクトップ（1025px ～）**: サイドバー + メインコンテンツ

### CSS アーキテクチャ

#### スタイリング戦略

スタイリングは次の優先順位で行います。

1. **Tailwind CSS**: 基本的に全てのスタイルを Tailwind CSS で実装します。
2. **CSS Modules + SCSS**: Tailwind CSS で実装できないスタイルは、CSS Modules と SCSS を使用します。
3. **Inline Styles**: 動的に CSS を変更する必要がある場合は、React の inline styles を使用します。しかし、可能な限り CSS Modules や Tailwind CSS を使用して動的なスタイルを実装してください。

---

最終更新: 2025 年 6 月 30 日（レスポンシブデザイン仕様追加）
