# Cloudflare Mailbox 開発ガイドライン

このドキュメントには、このリポジトリの開発に関するガイドラインが含まれています。開発者は日本人であるため、PR や Issue の内容は日本語で記載してください。

そのため、リポジトリに含まれる英語のドキュメントは全て日本語から翻訳されたものです。例えば CLAUDE.md は、CLAUDE_ja.md を英語に翻訳したものです。そのため、CLAUDE.md のみを編集することは避けてください。CLAUDE_ja.md を編集したコミットの後に CLAUDE.md を更新するコミットを作成してください。

## コーディングルール

このリポジトリでは、以下のコーディングルールを採用しています。

### TypeScript (主に型に関するルール)

- アサーションは一切使用しないこと、使用する場合はコメントに理由を記載すること
  - ただし、`as const`や`satisfies`は使用してもよい
- `any`や`unknown`は使用しないこと
- `inteface`は`type`で代用できる場合は使用しないこと
- 複雑な型は`type`で定義すること、export するのも可

### 命名規則

#### キャメルケース (ローワーキャメルケース)

- 変数名
- 関数名
- クラス名のインスタンス変数
- クラス名のメソッド名

#### パスカルケース (アッパーキャメルケース)

- クラス名
- タイプエイリアス

### JavaScript (主に構文に関するルール)

- let はなるべく使用しないこと、const を使用すること
- forEach はなるべく使用しないこと、map や filter を使用すること
  - for of は使用してもよい
- function キーワードはなるべく使用しないこと、原則 const とアロー関数で定義すること
- Promise の then はなるべく使用しないこと、async/await を使用すること
- オブジェクトのプロパティの順序は、以下の順にすること
  - プロパティ名
  - コンストラクタ
  - メソッド
  - getter/setter

# Cloudflare Mailbox システム仕様書

## 概要

Cloudflare Workers と KV を使用したメールボックス管理システム。複数のメールアドレスを一元管理し、効率的なメール処理を提供します。

## 主要機能

### 1. ユーザー管理システム

#### 認証方式

- **ユーザー名ベース認証**: メールアドレスではなくユーザー名でログイン
- **招待制**: 管理者が発行した招待トークンによる登録のみ
- **セッション管理**: JWT 形式でのセッション管理

#### ユーザー情報

```typescript
User {
  id: string (UUID)
  username: string (3-30文字、英数字とアンダースコア)
  email: string (連絡用メールアドレス)
  managedEmails: string[] (管理対象メールアドレス一覧)
  passwordHash: string
  createdAt: number
  lastLogin?: number
}
```

**重要な制約**:

- `email`（連絡用）と`managedEmails`（管理用）は重複不可
- `email`: システム通知・パスワードリセット等の連絡先
- `managedEmails`: 実際にメール受信・管理するアドレス

### 2. 複数メールボックス管理

#### 基本概念

- 1 ユーザーが複数のメールアドレスを管理可能
- 各メールアドレスは独立した inbox を持つ
- 統合ビューでの一括表示も可能

#### API 機能

- **統合表示**: 全管理メールボックスの統合表示
- **個別表示**: 特定メールボックスのみ表示
- **アクセス制御**: 管理対象メールアドレスのみアクセス可能

### 3. パフォーマンス最適化

#### KV 設計

- **O(1)アクセス**: ユーザー名インデックス (`username:key → userId`)
- **list 操作回避**: 高コストな list 操作を最小限に抑制
- **並列処理**: 複数メールボックスの並列取得

#### データ構造

```
KV構造:
- user:{userId} → User情報
- username:{username} → userId (インデックス)
- session:{sessionId} → Session情報
- inbox:{email} → EmailMetadata[]
- msg:{messageId} → EmailMessage
- thread:{threadId} → messageId[]
```

### KV 最適化戦略

1. **インデックス活用**: 頻繁アクセスは専用インデックス作成
2. **list 操作回避**: 管理画面等の低頻度のみ list 使用
3. **並列処理**: Promise.all による効率的なデータ取得
4. **クライアント処理**: ソート・フィルタリングはクライアント側

### パフォーマンス考慮事項

- ログイン時の O(1)ユーザー検索
- 複数メールボックスの並列取得
- クライアント側でのメール統合・ソート
- 高コストな list 操作の最小化

## 現在の実装状況

### ✅ 完了済み機能

#### 認証・セッション管理
- **React Router v7 + KV統合**: Cookie（sessionId）+ KV（セッションデータ）のハイブリッド構成
- **管理者認証**: IP制限 + セッション認証、初期セットアップ対応
- **ユーザー認証**: 招待制登録、ユーザー名ベースログイン
- **統一セッション管理**: `session.server.ts`で管理者・ユーザー両方を統一管理

#### メール機能
- **メール一覧**: 複数メールボックス統合表示、個別表示切り替え
- **メール詳細**: HTML/テキスト表示、添付ファイル対応
- **既読管理**: 個別メール既読化、未読カウント表示
- **検索・フィルタ**: 送信者、件名、日付範囲での絞り込み

#### 管理者機能
- **ダッシュボード**: 統計情報表示（ユーザー数、管理者数）
- **ユーザー管理**: 一覧表示、削除機能
- **招待管理**: 招待URL生成、管理画面
- **管理者管理**: 管理者追加、一覧、削除

#### UI実装
- **レスポンシブ設計**: デスクトップ・モバイル対応
- **ランディングページ**: 未認証ユーザー向けホーム
- **ユーザーダッシュボード**: 認証後のメイン画面

### 🚧 実装中・未完了機能

#### ユーザー設定
- **プロフィール管理**: `/profile` - ユーザー情報表示・編集
- **パスワード変更**: `/settings/password` - セキュアなパスワード更新
- **管理メールアドレス設定**: 追加・削除機能

#### メール機能拡張
- **ページネーション**: 大量メール対応の一覧表示改善
- **フォルダ管理**: カスタムフォルダ作成・メール移動
- **署名付きURL**: 添付ファイルの外部アクセス対応

#### UI/UX改善
- **ダークモード対応**: テーマ切り替え機能
- **通知・トースト**: ユーザーフィードバック強化
- **ローディング状態**: 操作中の適切な状態表示

### 🏗️ アーキテクチャ特徴

#### React Router v7対応
- **File-based routing**: 直感的なルート構成
- **Loader/Action pattern**: データ取得・更新の分離
- **Type-safe**: TypeScript完全対応

#### Cloudflare Workers最適化
- **Edge computing**: 世界中の低レイテンシ配信
- **KV Storage**: 効率的なデータ永続化
- **R2 Storage**: 添付ファイルの安全な保存

#### セキュリティ対策
- **IP制限**: 管理者アクセスの地理的制限
- **セッション管理**: 適切な期限切れ・無効化
- **アクセス制御**: 管理対象メールアドレスベースの権限制御

## 今後の拡張予定

### 短期計画（1-2ヶ月）
- ユーザープロフィール・設定画面完成
- ページネーション実装
- UI/UX改善（ダークモード、通知機能）

### 中期計画（3-6ヶ月）
- カスタムフォルダ機能
- メール送信機能
- 高度な検索・フィルタリング

### 長期計画（6ヶ月以上）
- メトリクス・ログ収集
- 障害監視・アラート
- バックアップ・復旧システム
- スケーリング対応

---

最終更新: 2025 年 6 月 29 日
